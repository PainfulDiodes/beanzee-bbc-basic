ACORN.asm:
     1                          	; TITLE COPYRIGHT (C) R.T.RUSSELL 1983-2024
     2                          ;
     3                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     4                          ;* ACORN COMPUTERS Z80 TUBE VERSION  *
     5                          ;(C) COPYRIGHT R.T.RUSSELL, 02-01-1984
     6                          ;VERSION 5.0, 12-07-2024
     7                          ;
     8                          OSWRCH	EQU	0FFEEH
     9                          OSWORD	EQU	0FFF1H
    10                          OSBYTE	EQU	0FFF4H
    11                          ;
    12                          ESC	EQU	1BH
    13                          TBY	EQU	0FH
    14                          TTO	EQU	0B8H
    15                          TFILL	EQU	03H
    16                          ;
    17                          	EXTERN ITEMI
    18                          	EXTERN EXPRI
    19                          	EXTERN COMMA
    20                          	EXTERN TERMQ
    21                          	EXTERN BRAKET
    22                          	EXTERN EXTERR
    23                          	EXTERN STOREN
    24                          	EXTERN TRAP
    25                          	EXTERN VAR
    26                          	EXTERN NXT
    27                          	EXTERN XEQ
    28                          ;
    29                          	EXTERN ACCS
    30                          	EXTERN COUNT
    31                          	EXTERN WIDTH
    32                          	EXTERN SCRAP
    33                          ;
    34                          	PUBLIC OSCALL
    35                          	PUBLIC CLRSCN
    36                          	PUBLIC PUTCSR
    37                          	PUBLIC GETCSR
    38                          	PUBLIC PUTIME
    39                          	PUBLIC GETIME
    40                          	PUBLIC OSKEY
    41                          ;
    42                          	PUBLIC CLG
    43                          	PUBLIC MOVE
    44                          	PUBLIC DRAW
    45                          	PUBLIC PLOT
    46                          	PUBLIC MODE
    47                          	PUBLIC COLOUR
    48                          	PUBLIC GCOL
    49                          	PUBLIC ADVAL
    50                          	PUBLIC SOUND
    51                          	PUBLIC ENVEL
    52                          	PUBLIC POINT
    53                          ;
    54                          	PUBLIC CIRCLE
    55                          	PUBLIC ELLIPS
    56                          	PUBLIC FILL
    57                          	PUBLIC MOUSE
    58                          	PUBLIC ORIGIN
    59                          	PUBLIC RECTAN
    60                          	PUBLIC LINE
    61                          	PUBLIC TINT
    62                          	PUBLIC WAIT
    63                          	PUBLIC SYS
    64                          	PUBLIC CSRON
    65                          	PUBLIC CSROFF
    66                          ;
    67                          	PUBLIC PUTIMS
    68                          	PUBLIC GETIMS
    69                          	PUBLIC TINTFN
    70                          	PUBLIC MODEFN
    71                          	PUBLIC WIDFN
    72                          ;
    73                          ;GETIME	- Read elapsed-time clock.
    74                          ;  	  Outputs:  DEHL = elapsed time (centiseconds)
    75                          ; 	  Destroys: A,D,E,H,L,F
    76                          ;
    77  0000  3e01              GETIME:	LD	A,1
    78  0002  210000            	LD	HL,SCRAP
    79  0005  cdf1ff            	CALL	OSWORD
    80  0008  210000            	LD	HL,SCRAP
    81  000b  5e                	LD	E,(HL)
    82  000c  23                	INC	HL
    83  000d  56                	LD	D,(HL)
    84  000e  23                	INC	HL
    85  000f  7e                	LD	A,(HL)
    86  0010  23                	INC	HL
    87  0011  66                	LD	H,(HL)
    88  0012  6f                	LD	L,A
    89  0013  eb                	EX	DE,HL
    90  0014  c9                	RET
    91                          ;
    92                          ;GETIMS	- Read real-time clock as string.
    93                          ;  	  Outputs:  TIME$ in string accumulator
    94                          ;                   E = string length (25)
    95                          ; 	  Destroys: A,B,C,D,E,H,L,F
    96                          ;
    97  0015  3e0e              GETIMS:	LD	A,14
    98  0017  210000            	LD	HL,SCRAP
    99  001a  3600              	LD	(HL),0
   100  001c  cdf1ff            	CALL	OSWORD
   101  001f  210000            	LD	HL,SCRAP
   102  0022  110000            	LD	DE,ACCS
   103  0025  7e                	LD	A,(HL)
   104  0026  bb                	CP	E
   105  0027  c8                	RET	Z
   106  0028  011900            	LD	BC,25
   107  002b  edb0              	LDIR
   108  002d  c9                	RET
   109                          ;
   110                          ;
   111                          ;PUTIME	- Load elapsed-time clock.
   112                          ;   	  Inputs:   DEHL = time to load (centiseconds)
   113                          ; 	  Destroys: A,D,E,H,L,F
   114                          ;
   115  002e  dde5              PUTIME:	PUSH	IX
   116  0030  dd210000          	LD	IX,SCRAP
   117  0034  dd7500            	LD	(IX+0),L
   118  0037  dd7401            	LD	(IX+1),H
   119  003a  dd7302            	LD	(IX+2),E
   120  003d  dd7203            	LD	(IX+3),D
   121  0040  3e02              	LD	A,2
   122  0042  210000            	LD	HL,SCRAP
   123  0045  cdf1ff            	CALL	OSWORD
   124  0048  dde1              	POP	IX
   125  004a  c9                	RET
   126                          ;
   127                          ;PUTIMS	- Wtite real-time clock as string.
   128                          ;  	  Inputs:   string in string accumulator
   129                          ;                   E = string length
   130                          ; 	  Destroys: A,B,C,D,E,H,L,F
   131                          ;
   132  004b  7b                PUTIMS:	LD	A,E		;Length
   133  004c  fe1a              	CP	26
   134  004e  d0                	RET	NC
   135  004f  0600              	LD	B,0
   136  0051  4f                	LD	C,A
   137  0052  110100            	LD	DE,SCRAP+1
   138  0055  210000            	LD	HL,ACCS
   139  0058  edb0              	LDIR
   140  005a  210000            	LD	HL,SCRAP
   141  005d  77                	LD	(HL),A
   142  005e  3e0f              	LD	A,15
   143  0060  c3f1ff            	JP	OSWORD
   144                          ;
   145                          ;
   146                          ;CLRSCN	- Clear screen.
   147                          ; 	  Destroys: A,D,E,H,L,F
   148                          ;
   149  0063  3e0c              CLRSCN:	LD	A,0CH
   150  0065  c3eeff            	JP	OSWRCH
   151                          ;
   152                          ;
   153                          ;OSKEY	- Sample keyboard with specified wait.
   154                          ;   	  Inputs:   HL = Time to wait (centiseconds)
   155                          ;  	  Outputs:  Carry reset indicates time-out.
   156                          ;                   If carry set, A = character typed.
   157                          ; 	  Destroys: A,D,E,H,L,F
   158                          ;
   159  0068  3e81              OSKEY:	LD	A,129
   160  006a  cdf4ff            	CALL	OSBYTE
   161  006d  7c                	LD	A,H
   162  006e  b7                	OR	A
   163  006f  c0                	RET	NZ		;TIME-OUT, CARRY RESET
   164  0070  7d                	LD	A,L
   165  0071  37                	SCF
   166  0072  c9                	RET			;NORMAL, CARRY SET
   167                          ;
   168                          ;PUTCSR	- Move cursor to specified position.
   169                          ;   	  Inputs:   DE = horizontal position (LHS=0)
   170                          ;                   HL = vertical position (TOP=0)
   171                          ; 	  Destroys: A,D,E,H,L,F
   172                          ;
   173  0073  3e1f              PUTCSR:	LD	A,1FH
   174  0075  cdeeff            	CALL	OSWRCH
   175  0078  7b                	LD	A,E
   176  0079  cdeeff            	CALL	OSWRCH
   177  007c  7d                	LD	A,L
   178  007d  c3eeff            	JP	OSWRCH
   179                          ;
   180                          ;GETCSR	- Return cursor coordinates.
   181                          ;   	  Outputs:  DE = X coordinate (POS)
   182                          ;                   HL = Y coordinate (VPOS)
   183                          ;  	  Destroys: A,D,E,H,L,F
   184                          ;
   185  0080  3e86              GETCSR:	LD	A,134
   186  0082  cdf4ff            	CALL	OSBYTE
   187  0085  5d                	LD	E,L
   188  0086  6c                	LD	L,H
   189  0087  1600              	LD	D,0
   190  0089  62                	LD	H,D
   191  008a  c9                	RET
   192                          ;
   193                          ;POINT - var=POINT(x,y)
   194                          ;
   195  008b  cd0000            POINT:	CALL	EXPRI
   196  008e  d9                	EXX
   197  008f  e5                	PUSH	HL
   198  0090  cdc803            	CALL	CEXPRI
   199  0093  d9                	EXX
   200  0094  d1                	POP	DE
   201  0095  cd0000            	CALL	BRAKET
   202  0098  dd210000          	LD	IX,SCRAP
   203  009c  dd7300            	LD	(IX+0),E
   204  009f  dd7201            	LD	(IX+1),D
   205  00a2  dd7502            	LD	(IX+2),L
   206  00a5  dd7403            	LD	(IX+3),H
   207  00a8  210000            	LD	HL,SCRAP
   208  00ab  3e09              	LD	A,9
   209  00ad  cdf1ff            	CALL	OSWORD
   210  00b0  dd7e04            	LD	A,(IX+4)
   211  00b3  6f                	LD	L,A
   212  00b4  c601              	ADD	A,1
   213  00b6  9f                	SBC	A,A
   214  00b7  67                	LD	H,A
   215  00b8  d9                RETEXX:	EXX
   216  00b9  67                	LD	H,A
   217  00ba  6f                	LD	L,A
   218  00bb  af                	XOR	A
   219  00bc  4f                	LD	C,A
   220  00bd  c9                	RET
   221                          ;
   222                          ;ADVAL - var=ADVAL(n)
   223                          ;
   224  00be  cd0000            ADVAL:	CALL	ITEMI
   225  00c1  d9                	EXX
   226  00c2  3e80              	LD	A,128
   227  00c4  cdf4ff            	CALL	OSBYTE
   228  00c7  af                	XOR	A
   229  00c8  18ee              	JR	RETEXX
   230                          ;
   231                          ;MODEFN - var=MODE
   232                          ;
   233  00ca  3e87              MODEFN:	LD	A,135
   234  00cc  cdf4ff            	CALL	OSBYTE
   235  00cf  6c                	LD	L,H
   236  00d0  af                RETU8:	XOR	A
   237  00d1  67                	LD	H,A
   238  00d2  18e4              	JR	RETEXX
   239                          ;
   240                          ;WIDFN - var=WIDTH
   241                          ;
   242  00d4  3a0000            WIDFN:	LD	A,(WIDTH)
   243  00d7  6f                	LD	L,A
   244  00d8  18f6              	JR	RETU8
   245                          ;
   246                          ;ENVEL - ENVELOPE var,var,var,var,var,var,var,
   247                          ;                 var,var,var,var,var,var,var
   248                          ;
   249  00da  0600              ENVEL:	LD	B,0
   250  00dc  dd210000          	LD	IX,SCRAP
   251  00e0  c5                	PUSH	BC
   252  00e1  dde5              	PUSH	IX
   253  00e3  cd0000            ENVEL1:	CALL	EXPRI
   254  00e6  d9                	EXX
   255  00e7  dde1              	POP	IX
   256  00e9  c1                	POP	BC
   257  00ea  dd7500            	LD	(IX),L
   258  00ed  78                	LD	A,B
   259  00ee  fe0d              	CP	13
   260  00f0  280b              	JR	Z,ENVEL2
   261  00f2  04                	INC	B
   262  00f3  dd23              	INC	IX
   263  00f5  c5                	PUSH	BC
   264  00f6  dde5              	PUSH	IX
   265  00f8  cd0000            	CALL	COMMA
   266  00fb  18e6              	JR	ENVEL1
   267  00fd  210000            ENVEL2:	LD	HL,SCRAP
   268  0100  3e08              	LD	A,8
   269  0102  cdf1ff            	CALL	OSWORD
   270  0105  c30000            	JP	XEQ
   271                          ;
   272                          ;SOUND - SOUND var,var,var,var
   273                          ;
   274  0108  0600              SOUND:	LD	B,0
   275  010a  dd210000          	LD	IX,SCRAP
   276  010e  c5                	PUSH	BC
   277  010f  dde5              	PUSH	IX
   278  0111  cd0000            SOUND1:	CALL	EXPRI
   279  0114  d9                	EXX
   280  0115  dde1              	POP	IX
   281  0117  c1                	POP	BC
   282  0118  dd7500            	LD	(IX+0),L
   283  011b  dd7401            	LD	(IX+1),H
   284  011e  dd23              	INC	IX
   285  0120  dd23              	INC	IX
   286  0122  04                	INC	B
   287  0123  04                	INC	B
   288  0124  78                	LD	A,B
   289  0125  fe08              	CP	8
   290  0127  2808              	JR	Z,SOUND2
   291  0129  c5                	PUSH	BC
   292  012a  dde5              	PUSH	IX
   293  012c  cd0000            	CALL	COMMA
   294  012f  18e0              	JR	SOUND1
   295  0131  210000            SOUND2:	LD	HL,SCRAP
   296  0134  3e07              	LD	A,7
   297  0136  cdf1ff            	CALL	OSWORD
   298  0139  c30000            	JP	XEQ
   299                          ;
   300                          ;MODE - MODE n
   301                          ;
   302  013c  cd0000            MODE:	CALL	EXPRI
   303  013f  af                	XOR	A
   304  0140  320000            	LD	(COUNT),A
   305  0143  d9                	EXX
   306  0144  65                	LD	H,L
   307  0145  2e16              	LD	L,22
   308  0147  cdaf03            	CALL	WRCH2
   309  014a  1872              	JR	XEQGO1
   310                          ;
   311                          ;CLG
   312                          ;
   313  014c  3e10              CLG:	LD	A,16
   314  014e  cdeeff            	CALL	OSWRCH
   315  0151  186b              	JR	XEQGO1
   316                          ;
   317                          ;ORIGIN x,y
   318                          ;
   319  0153  cd0000            ORIGIN: CALL    EXPRI
   320  0156  d9                        EXX
   321  0157  e5                	PUSH	HL
   322  0158  cdc803                    CALL    CEXPRI
   323  015b  d9                	EXX
   324  015c  d1                        POP	DE
   325  015d  0e1d              	LD	C,29
   326  015f  cda303            	CALL	WRCH5
   327  0162  185a                      JR	XEQGO1
   328                          ;
   329                          ;COLOUR n
   330                          ;COLOUR n,p
   331                          ;COLOUR n,r,g,b
   332                          ;
   333  0164  cd0000            COLOUR:	CALL	EXPRI		;n
   334  0167  d9                	EXX
   335  0168  fd7e00            	LD	A,(IY)
   336  016b  fe2c              	CP	','
   337  016d  2808                      JR      Z,PALCOL
   338  016f  65                	LD	H,L
   339  0170  2e11              	LD	L,17
   340  0172  cdaf03            	CALL	WRCH2
   341  0175  1847              	JR	XEQGO1
   342                          ;
   343  0177  e5                PALCOL:	PUSH	HL
   344  0178  cdc803            	CALL	CEXPRI		;p or r
   345  017b  d9                	EXX
   346  017c  eb                	EX	DE,HL
   347  017d  210000            	LD	HL,0
   348  0180  fd7e00            	LD	A,(IY)
   349  0183  fe2c              	CP	','
   350  0185  2015              	JR	NZ,PALET1
   351  0187  d5                	PUSH	DE
   352  0188  cdc803            	CALL	CEXPRI		;g
   353  018b  d9                	EXX
   354  018c  e5                	PUSH	HL
   355  018d  cdc803            	CALL	CEXPRI		;b
   356  0190  d9                	EXX
   357  0191  d1                	POP	DE
   358  0192  c1                	POP	BC
   359  0193  7d                	LD	A,L
   360  0194  e1                	POP	HL
   361  0195  51                	LD	D,C		;r
   362  0196  4d                	LD	C,L		;n
   363  0197  6b                	LD	L,E		;g
   364  0198  67                	LD	H,A		;b
   365  0199  1e10              	LD	E,16
   366  019b  c5                	PUSH	BC
   367  019c  c1                PALET1:	POP	BC
   368  019d  0613              	LD	B,19
   369  019f  cd9f03            	CALL	WRCH6
   370  01a2  181a              	JR	XEQGO1
   371                          ;
   372                          ;GCOL [a,]b
   373                          ;
   374  01a4  cd0000            GCOL:	CALL	EXPRI
   375  01a7  d9                	EXX
   376  01a8  1e00              	LD	E,0
   377  01aa  fd7e00            	LD	A,(IY)
   378  01ad  fe2c              	CP	','
   379  01af  2006              	JR	NZ,GCOL0
   380  01b1  e5                	PUSH	HL
   381  01b2  cdc803            	CALL	CEXPRI
   382  01b5  d9                	EXX
   383  01b6  d1                	POP	DE
   384  01b7  65                GCOL0:	LD	H,L
   385  01b8  6b                	LD	L,E
   386  01b9  1612              	LD	D,18
   387  01bb  cdab03            	CALL	WRCH3		;DLH
   388  01be  c30000            XEQGO1:	JP	XEQ
   389                          ;
   390                          ;CSRON  - Turn caret on
   391                          ;CSROFF - Turn caret off
   392                          ;
   393  01c1  0e01              CSRON:	LD	C,1
   394  01c3  1802              	JR	CSRGO
   395                          ;
   396  01c5  0e00              CSROFF:	LD	C,0
   397  01c7  3e17              CSRGO:	LD	A,23
   398  01c9  cdeeff            	CALL	OSWRCH
   399  01cc  3e01              	LD	A,1
   400  01ce  cdeeff            	CALL	OSWRCH
   401  01d1  79                	LD	A,C
   402  01d2  0608              	LD	B,8
   403  01d4  cdeeff            CSRGO1:	CALL	OSWRCH
   404  01d7  af                	XOR	A
   405  01d8  10fa              	DJNZ	CSRGO1
   406  01da  18e2              	JR	XEQGO1
   407                          ;
   408                          ;LINE x1,y1,x2,y2
   409                          ;
   410  01dc  cd0000            LINE:	CALL	EXPRI
   411  01df  d9                	EXX
   412  01e0  e5                	PUSH	HL
   413  01e1  cdb703            	CALL	EXPR3
   414  01e4  e3                	EX	(SP),HL		;HL <- x1, (SP) <- y2
   415  01e5  c5                	PUSH	BC
   416  01e6  eb                	EX	DE,HL
   417  01e7  0e04              	LD	C,4
   418  01e9  cd9d03            	CALL	VDU25
   419  01ec  d1                	POP	DE
   420  01ed  e1                	POP	HL
   421  01ee  0e05              	LD	C,5
   422  01f0  182a              	JR	PLOT4A
   423                          ;
   424                          ;CIRCLE [FILL] x,y,r
   425                          ;
   426  01f2  fe03              CIRCLE:	CP	TFILL
   427  01f4  f5                	PUSH	AF
   428  01f5  2002              	JR	NZ,CIRCL0
   429  01f7  fd23              	INC	IY
   430  01f9  cd0000            CIRCL0:	CALL	EXPRI
   431  01fc  d9                	EXX
   432  01fd  e5                	PUSH	HL
   433  01fe  cdc803            	CALL	CEXPRI
   434  0201  d9                	EXX
   435  0202  e5                	PUSH	HL
   436  0203  cdc803            	CALL	CEXPRI
   437  0206  d9                	EXX
   438  0207  c1                	POP	BC		;y
   439  0208  d1                	POP	DE		;x
   440  0209  e5                	PUSH	HL
   441  020a  69                	LD	L,C
   442  020b  60                	LD	H,B
   443  020c  0e04              	LD	C,4		; PLOT 4 = MOVE
   444  020e  cd9d03            	CALL	VDU25
   445  0211  d1                	POP	DE		;r
   446  0212  210000            	LD	HL,0
   447  0215  f1                        POP	AF
   448  0216  0e91              	LD	C,145		; PLOT 145 = outline circle
   449  0218  2002              	JR	NZ,PLOT4A
   450  021a  0e99              	LD	C,153		; PLOT 153 = filled circle
   451  021c  186c              PLOT4A:	JR	PLOT4
   452                          ;
   453                          ;ELLIPSE [FILL] x,y,a,b
   454                          ;
   455  021e  fe03              ELLIPS:	CP	TFILL
   456  0220  f5                	PUSH	AF
   457  0221  2002              	JR	NZ,ELLIP0
   458  0223  fd23              	INC	IY
   459  0225  cd0000            ELLIP0:	CALL	EXPRI
   460  0228  d9                	EXX
   461  0229  e5                	PUSH	HL
   462  022a  cdb703            	CALL	EXPR3
   463  022d  e3                	EX	(SP),HL		;HL <- x, (SP) <- b
   464  022e  c5                	PUSH	BC
   465  022f  eb                	EX	DE,HL
   466  0230  0e04              	LD	C,4		; PLOT 4 = Move absolute
   467  0232  cd9d03            	CALL	VDU25
   468  0235  d1                	POP	DE		;a
   469  0236  d5                	PUSH	DE
   470  0237  210000            	LD	HL,0
   471  023a  4d                	LD	C,L		; PLOT 0 - Move relative
   472  023b  cd9d03            	CALL	VDU25
   473  023e  d1                        POP	DE		;a
   474  023f  af                	XOR	A
   475  0240  6f                	LD	L,A
   476  0241  67                	LD	H,A
   477  0242  ed52              	SBC	HL,DE
   478  0244  eb                	EX	DE,HL
   479  0245  e1                	POP	HL		;b
   480  0246  f1                	POP	AF
   481  0247  0ec1              	LD	C,193		; PLOT 193 = outline ellipse
   482  0249  203f              	JR	NZ,PLOT4
   483  024b  0ec9              	LD	C,201		; PLOT 201 = filled ellipse
   484  024d  183b              	JR	PLOT4
   485                          ;
   486                          ;MOVE [BY} x,y
   487                          ;DRAW [BY] x,y
   488                          ;PLOT [BY] [n,]x,y
   489                          ;FILL [BY] x,y
   490                          ;
   491  024f  0e04              MOVE:	LD	C,4
   492  0251  1823              	JR	PLOT1
   493                          ;
   494  0253  0e05              DRAW:	LD	C,5
   495  0255  181f              	JR	PLOT1
   496                          ;
   497  0257  0e85              FILL:	LD	C,133
   498  0259  181b              	JR	PLOT1
   499                          ;
   500  025b  0e45              PLOT:	LD	C,69
   501  025d  fe0f              	CP	TBY
   502  025f  2815              	JR	Z,PLOT1
   503  0261  cd0000            	CALL	EXPRI
   504  0264  d9                	EXX
   505  0265  e5                	PUSH	HL
   506  0266  cdc803            	CALL	CEXPRI
   507  0269  d9                	EXX
   508  026a  fd7e00            	LD	A,(IY)
   509  026d  fe2c              	CP	','
   510  026f  2812              	JR	Z,PLOT3
   511  0271  d1                	POP	DE
   512  0272  0e45              	LD	C,69
   513  0274  1814              	JR	PLOT4
   514                          ;
   515  0276  fe0f              PLOT1:	CP	TBY
   516  0278  2004              	JR	NZ,PLOT2
   517  027a  fd23              	INC	IY
   518  027c  cb91              	RES	2,C		;Change absolute to relative
   519  027e  c5                PLOT2:	PUSH	BC
   520  027f  cd0000            	CALL	EXPRI
   521  0282  d9                	EXX
   522  0283  e5                PLOT3:	PUSH	HL
   523  0284  cdc803            	CALL	CEXPRI
   524  0287  d9                	EXX
   525  0288  d1                	POP	DE
   526  0289  c1                	POP	BC
   527  028a  cd9d03            PLOT4:	CALL	VDU25
   528  028d  c30000            	JP	XEQ
   529                          ;
   530                          ;RECTANGLE [FILL] x,y,w[,h] [TO xnew,ynew]
   531                          ;
   532  0290  fe03              RECTAN:	CP	TFILL
   533  0292  f5                	PUSH	AF
   534  0293  2002              	JR	NZ,RECT0
   535  0295  fd23              	INC	IY
   536  0297  cd0000            RECT0:	CALL	EXPRI
   537  029a  d9                	EXX
   538  029b  e5                	PUSH	HL
   539  029c  cdc803            	CALL	CEXPRI
   540  029f  d9                	EXX
   541  02a0  e5                	PUSH	HL
   542  02a1  cdc803            	CALL	CEXPRI
   543  02a4  d9                	EXX
   544  02a5  e5                	PUSH	HL
   545  02a6  fd7e00            	LD	A,(IY)
   546  02a9  fe2c              	CP	','
   547  02ab  2004              	JR	NZ,RECT1
   548  02ad  cdc803            	CALL	CEXPRI
   549  02b0  d9                	EXX
   550  02b1  c1                RECT1:	POP	BC		;w
   551  02b2  d1                	POP	DE		;y
   552  02b3  e3                	EX	(SP),HL		;HL <- x, (SP) <- h
   553  02b4  c5                	PUSH	BC
   554  02b5  eb                	EX	DE,HL
   555  02b6  0e04              	LD	C,4
   556  02b8  cd9d03            	CALL	VDU25
   557  02bb  fd7e00            	LD	A,(IY)
   558  02be  feb8              	CP	TTO
   559  02c0  2809              	JR	Z,RECTTO
   560  02c2  d1                	POP	DE		;w
   561  02c3  e1                	POP	HL		;h
   562  02c4  f1                	POP	AF
   563  02c5  2022              	JR	NZ,OUTLIN
   564  02c7  0e61              	LD	C,97
   565  02c9  18bf              	JR	PLOT4
   566                          ;
   567                          ;Block copy / move:
   568                          ;
   569  02cb  fd23              RECTTO:	INC	IY		; Bump over TO
   570  02cd  cd0000            	CALL	EXPRI
   571  02d0  d9                	EXX
   572  02d1  e5                	PUSH	HL
   573  02d2  cdc803            	CALL	CEXPRI
   574  02d5  d9                	EXX
   575  02d6  c1                	POP	BC		;newx
   576  02d7  d1                	POP	DE		;w
   577  02d8  e3                	EX	(SP),HL		;HL <- h, (SP) <- newy
   578  02d9  c5                	PUSH	BC
   579  02da  0e00              	LD	C,0
   580  02dc  cd9d03            	CALL	VDU25
   581  02df  d1                	POP	DE		;newx
   582  02e0  e1                	POP	HL		;newy
   583  02e1  f1                	POP	AF
   584  02e2  0ebe              	LD	C,190		; PLOT 190 - Block copy
   585  02e4  2001              	JR	NZ,PLOT4B
   586  02e6  0d                	DEC	C		; PLOT 189 - Block move
   587  02e7  18a1              PLOT4B:	JR	PLOT4
   588                          ;
   589                          ;Outline rectangle:
   590                          ;
   591  02e9  0e09              OUTLIN:	LD	C,9		; PLOT 9 - draw relative
   592  02eb  e5                	PUSH	HL
   593  02ec  210000            	LD	HL,0
   594  02ef  cd9d03            	CALL	VDU25		; side 1
   595  02f2  e1                	POP	HL
   596  02f3  d5                	PUSH	DE
   597  02f4  110000            	LD	DE,0
   598  02f7  cd9d03            	CALL	VDU25		; side 2
   599  02fa  d1                	POP	DE
   600  02fb  e5                	PUSH	HL
   601  02fc  af                	XOR	A
   602  02fd  6f                	LD	L,A
   603  02fe  67                	LD	H,A
   604  02ff  ed52              	SBC	HL,DE
   605  0301  eb                	EX	DE,HL
   606  0302  6f                	LD	L,A
   607  0303  67                	LD	H,A
   608  0304  cd9d03            	CALL 	VDU25		; side 3
   609  0307  d1                	POP	DE
   610  0308  af                	XOR	A
   611  0309  6f                	LD	L,A
   612  030a  67                	LD	H,A
   613  030b  ed52              	SBC	HL,DE
   614  030d  5f                	LD	E,A
   615  030e  57                	LD	D,A
   616  030f  18d6              	JR	PLOT4B
   617                          ;
   618                          ;MOUSE x, y, b
   619                          ;
   620  0311  3e80              MOUSE:	LD	A,128
   621  0313  210900            	LD	HL,9
   622  0316  cdf4ff            	CALL	OSBYTE
   623  0319  e5                	PUSH	HL
   624  031a  3e80              	LD	A,128
   625  031c  210800            	LD	HL,8
   626  031f  cdf4ff            	CALL	OSBYTE
   627  0322  e5                	PUSH	HL
   628  0323  3e80              	LD	A,128
   629  0325  210700            	LD	HL,7
   630  0328  cdf4ff            	CALL	OSBYTE
   631  032b  e5                	PUSH	HL
   632  032c  cd0000            	CALL	VAR
   633  032f  e1                	POP	HL
   634  0330  cdce03            	CALL	STOREI
   635  0333  cd0000            	CALL	COMMA
   636  0336  cd0000            	CALL	NXT
   637  0339  cd0000            	CALL	VAR
   638  033c  e1                	POP	HL
   639  033d  cdce03            	CALL	STOREI
   640  0340  cd0000            	CALL	COMMA
   641  0343  cd0000            	CALL	NXT
   642  0346  cd0000            	CALL	VAR
   643  0349  e1                	POP	HL
   644  034a  cdce03            	CALL	STOREI
   645  034d  c30000            XEQGO2:	JP	XEQ
   646                          ;
   647                          ;WAIT [n]
   648                          ;
   649  0350  cd0000            WAIT:	CALL	TERMQ
   650  0353  28f8              	JR	Z,XEQGO2
   651  0355  cd0000            	CALL	EXPRI
   652  0358  d9                	EXX
   653  0359  44                	LD	B,H
   654  035a  4d                	LD	C,L
   655  035b  cd0000            	CALL	GETIME
   656  035e  09                	ADD	HL,BC
   657  035f  010000            	LD	BC,0
   658  0362  eb                	EX	DE,HL
   659  0363  ed4a              	ADC	HL,BC
   660  0365  eb                	EX	DE,HL
   661  0366  cd0000            WAIT1:	CALL	TRAP
   662  0369  d5                	PUSH	DE
   663  036a  e5                	PUSH	HL
   664  036b  cd0000            	CALL	GETIME
   665  036e  c1                	POP	BC
   666  036f  b7                	OR	A
   667  0370  ed42              	SBC	HL,BC
   668  0372  60                	LD	H,B
   669  0373  69                	LD	L,C
   670  0374  eb                	EX	DE,HL
   671  0375  c1                	POP	BC
   672  0376  ed42              	SBC	HL,BC
   673  0378  30d3              	JR	NC,XEQGO2
   674  037a  eb                	EX	DE,HL
   675  037b  50                	LD	D,B
   676  037c  59                	LD	E,C
   677  037d  18e7              	JR	WAIT1
   678                          ;
   679                          ;OSCALL - Trap call to FFxx
   680                          ;
   681  037f  e1                OSCALL:	POP	HL		;DITCH RETURN ADDRESS
   682  0380  219203            	LD	HL,OSRET
   683  0383  e5                	PUSH	HL		;NEW RETURN ADDRESS
   684  0384  dd7e04            	LD	A,(IX+4)	;A%
   685  0387  dd5e14            	LD	E,(IX+20)	;E%
   686  038a  dd6664            	LD	H,(IX+100)	;Y%
   687  038d  dd6e60            	LD	L,(IX+96)	;X%
   688  0390  fde9              	JP	(IY)
   689  0392  f5                OSRET:	PUSH	AF
   690  0393  7d                	LD	A,L		;F  H  L  A
   691  0394  6c                	LD	L,H		;|  |  |  |
   692  0395  d9                	EXX			;|  |  |  |
   693  0396  c1                	POP	BC		;|  |  |  |
   694  0397  67                	LD	H,A		;|  |  |  |
   695  0398  68                	LD	L,B		;H  L  H' L'
   696  0399  79                	LD	A,C
   697  039a  d9                	EXX
   698  039b  67                	LD	H,A
   699  039c  c9                	RET
   700                          ;
   701  039d  0619              VDU25:	LD	B,25
   702  039f  78                WRCH6:	LD	A,B
   703  03a0  cdeeff            	CALL	OSWRCH
   704  03a3  79                WRCH5:	LD	A,C
   705  03a4  cdeeff            	CALL	OSWRCH
   706  03a7  7b                WRCH4:	LD	A,E
   707  03a8  cdeeff            	CALL	OSWRCH
   708  03ab  7a                WRCH3:	LD	A,D
   709  03ac  cdeeff            	CALL	OSWRCH
   710  03af  7d                WRCH2:	LD	A,L
   711  03b0  cdeeff            	CALL	OSWRCH
   712  03b3  7c                	LD	A,H
   713  03b4  c3eeff            	JP	OSWRCH
   714                          ;
   715  03b7  cdc803            EXPR3:	CALL	CEXPRI
   716  03ba  d9                	EXX
   717  03bb  e5                	PUSH	HL
   718  03bc  cdc803            	CALL	CEXPRI
   719  03bf  d9                	EXX
   720  03c0  e5                	PUSH	HL
   721  03c1  cdc803            	CALL	CEXPRI
   722  03c4  d9                	EXX
   723  03c5  c1                	POP	BC		;x2
   724  03c6  d1                	POP	DE		;y1
   725  03c7  c9                	RET
   726                          ;
   727  03c8  cd0000            CEXPRI:	CALL	COMMA
   728  03cb  c30000            	JP	EXPRI
   729                          ;
   730  03ce  cb7f              STOREI:	BIT	7,A
   731  03d0  200c              	JR	NZ,EEK
   732  03d2  cb77              	BIT	6,A
   733  03d4  2008              	JR	NZ,EEK
   734  03d6  d9                	EXX
   735  03d7  210000            	LD	HL,0
   736  03da  4d                	LD	C,L
   737  03db  c30000            	JP	STOREN
   738                          ;
   739  03de  3e32              EEK:	LD	A,50
   740  03e0  cd0000            	CALL	EXTERR
   741  03e3  13                	DEFB	13H		;'Bad '
   742  03e4  04                	DEFB	04H		;'MOUSE'
   743  03e5  20                	DEFB	20H
   744  03e6  15                	DEFB	15H		;'variable'
   745  03e7  00                	DEFB	0
   746                          ;
   747                          TINT:
   748                          TINTFN:
   749                          SYS:
   750  03e8  af                	XOR	A
   751  03e9  cd0000            	CALL	EXTERR
   752  03ec  536f727279        	DEFM "Sorry"
   753  03f1  00                	DEFB	0
   754                          ;
   755                          	; END
   756                          
   757                          
