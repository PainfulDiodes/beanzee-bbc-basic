AMOS.asm:
     1                          	; TITLE BBC BASIC (C) R.T.RUSSELL 1984-2024
     2                          ;
     3                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     4                          ;* ACORN COMPUTERS Z80 TUBE VERSION  *
     5                          ;(C) COPYRIGHT R.T.RUSSELL, 08-05-1984
     6                          ;VERSION 5.0, 14-06-2024
     7                          ;
     8                          	PUBLIC OSINIT
     9                          	PUBLIC OSRDCH
    10                          	PUBLIC OSWRCH
    11                          	PUBLIC OSLINE
    12                          	PUBLIC OSSAVE
    13                          	PUBLIC OSLOAD
    14                          	PUBLIC OSOPEN
    15                          	PUBLIC OSSHUT
    16                          	PUBLIC OSBGET
    17                          	PUBLIC OSBPUT
    18                          	PUBLIC OSSTAT
    19                          	PUBLIC GETEXT
    20                          	PUBLIC GETPTR
    21                          	PUBLIC PUTPTR
    22                          	PUBLIC PROMPT
    23                          	PUBLIC RESET
    24                          	PUBLIC LTRAP
    25                          	PUBLIC OSCLI
    26                          	PUBLIC TRAP
    27                          	PUBLIC BYE
    28                          	PUBLIC SCRAP
    29                          ;
    30                          	EXTERN ESCAPE
    31                          	EXTERN EXTERR
    32                          	EXTERN CHECK
    33                          	EXTERN CRLF
    34                          ;
    35                          	EXTERN ACCS
    36                          	EXTERN FREE
    37                          	EXTERN CURLIN
    38                          	EXTERN USER
    39                          	EXTERN VERMSG
    40                          ;
    41                          ;OSSAVE - Save an area of memory to a file.
    42                          ;   Inputs: HL addresses filename (term CR)
    43                          ;           DE = start address of data to save
    44                          ;           BC = length of data to save (bytes)
    45                          ; Destroys: A,B,C,D,E,H,L,F
    46                          ;
    47  0000  cd5b04            STSAVE:	CALL	SAVLOD		;*SAVE
    48  0003  da2904            	JP	C,HUH		;"Bad command"
    49  0006  e5                	PUSH	HL
    50  0007  1804              	JR	OSS1
    51                          ;
    52  0009  c5                OSSAVE:	PUSH	BC		;SAVE
    53  000a  cdbd02            	CALL	SETUP0
    54  000d  eb                OSS1:	EX	DE,HL
    55  000e  cd5302            	CALL	CREATE
    56  0011  2014              	JR	NZ,SAVE
    57  0013  3ebe              	LD	A,190
    58  0015  cd0000            	CALL	EXTERR
    59  0018  4469726563746f72  	DEFM "Directory full"
              792066756c6c      
    60  0026  00                	DEFB	0
    61  0027  cd2502            SAVE:	CALL	WRITE
    62  002a  09                	ADD	HL,BC
    63  002b  e3                	EX	(SP),HL
    64  002c  ed42              	SBC	HL,BC
    65  002e  e3                	EX	(SP),HL
    66  002f  2802              	JR	Z,SAVE1
    67  0031  30f4              	JR	NC,SAVE
    68  0033  c1                SAVE1:	POP	BC
    69  0034  3e10              CLOSE:	LD	A,16
    70  0036  cdf901            	CALL	BDOS1
    71  0039  3c                	INC	A
    72  003a  c0                	RET	NZ
    73  003b  3ec8              	LD	A,200
    74  003d  cd0000            	CALL	EXTERR
    75  0040  436c6f7365206572  	DEFM "Close error"
              726f72            
    76  004b  00                	DEFB	0
    77                          ;
    78                          ;OSSHUT - Close disk file(s).
    79                          ;   Inputs: E = file channel
    80                          ;           If E=0 all files are closed
    81                          ; Destroys: A,B,C,D,E,H,L,F
    82                          ;
    83  004c  7b                OSSHUT:	LD	A,E
    84  004d  b7                	OR	A
    85  004e  200b              	JR	NZ,SHUTIT
    86  0050  1c                SHUT0:	INC	E
    87  0051  cb5b              	BIT	3,E
    88  0053  c0                	RET	NZ
    89  0054  d5                	PUSH	DE
    90  0055  cd6300            	CALL	SHUT1
    91  0058  d1                	POP	DE
    92  0059  18f5              	JR	SHUT0
    93                          ;
    94  005b  cdac02            SHUTIT:	CALL	FIND1
    95  005e  2007              	JR	NZ,SHUT2
    96  0060  c39702            	JP	CHANER
    97                          ;
    98  0063  cdac02            SHUT1:	CALL	FIND1
    99  0066  c8                	RET	Z
   100  0067  af                SHUT2:	XOR	A
   101  0068  77                	LD	(HL),A
   102  0069  2b                	DEC	HL
   103  006a  77                	LD	(HL),A
   104  006b  212500            	LD	HL,37
   105  006e  19                	ADD	HL,DE
   106  006f  cb7e              	BIT	7,(HL)
   107  0071  23                	INC	HL
   108  0072  c42502            	CALL	NZ,WRITE
   109  0075  21a600            	LD	HL,FCBSIZ
   110  0078  19                	ADD	HL,DE
   111  0079  ed4b0000          	LD	BC,(FREE)
   112  007d  ed42              	SBC	HL,BC
   113  007f  20b3              	JR	NZ,CLOSE
   114  0081  ed530000          	LD	(FREE),DE	;RELEASE SPACE
   115  0085  18ad              	JR	CLOSE
   116                          ;
   117                          ;TYPE - *TYPE command.
   118                          ;Types file to console output.
   119                          ;
   120  0087  37                TYPE:	SCF			;*TYPE
   121  0088  cdd700            	CALL	OSOPEN
   122  008b  b7                	OR	A
   123  008c  281e              	JR	Z,NOTFND
   124  008e  5f                	LD	E,A
   125  008f  cd5805            TYPE1:	CALL	TRAP		;IMPORTANT (ACORN)
   126  0092  cd4b01            	CALL	OSBGET
   127  0095  cdd005            	CALL	OSWRCH
   128  0098  30f5              	JR	NC,TYPE1
   129  009a  18b0              	JR	OSSHUT
   130                          ;
   131                          ;OSLOAD - Load an area of memory from a file.
   132                          ;   Inputs: HL addresses filename (term CR)
   133                          ;           DE = address at which to load
   134                          ;           BC = maximum allowed size (bytes)
   135                          ;  Outputs: Carry reset indicates no room for file.
   136                          ; Destroys: A,B,C,D,E,H,L,F
   137                          ;
   138  009c  cd5b04            STLOAD:	CALL	SAVLOD		;*LOAD
   139  009f  e5                	PUSH	HL
   140  00a0  1804              	JR	OSL1
   141                          ;
   142  00a2  c5                OSLOAD:	PUSH	BC		;LOAD
   143  00a3  cdbd02            	CALL	SETUP0
   144  00a6  eb                OSL1:	EX	DE,HL
   145  00a7  cd4902            	CALL	OPEN
   146  00aa  201d              	JR	NZ,LOAD0
   147  00ac  3ed6              NOTFND:	LD	A,214
   148  00ae  cd0000            	CALL	EXTERR
   149  00b1  46696c65206e6f74  	DEFM "File not found"
              20666f756e64      
   150  00bf  00                	DEFB	0
   151  00c0  cdf401            LOAD:	CALL	READ
   152  00c3  200a              	JR	NZ,LOAD1
   153  00c5  cd3e02            	CALL	INCSEC
   154  00c8  09                	ADD	HL,BC
   155  00c9  e3                LOAD0:	EX	(SP),HL
   156  00ca  ed42              	SBC	HL,BC
   157  00cc  e3                	EX	(SP),HL
   158  00cd  30f1              	JR	NC,LOAD
   159  00cf  c1                LOAD1:	POP	BC
   160  00d0  f5                	PUSH	AF
   161  00d1  cd3400            	CALL	CLOSE
   162  00d4  f1                	POP	AF
   163  00d5  3f                	CCF
   164  00d6  c9                RESET:	RET
   165                          ;
   166                          ;OSOPEN - Open a file for reading or writing.
   167                          ;   Inputs: HL addresses filename (term CR)
   168                          ;           Carry set for OPENIN, cleared for OPENOUT.
   169                          ;  Outputs: A = file channel (=0 if cannot open)
   170                          ; Destroys: A,B,C,D,E,H,L,F
   171                          ;
   172  00d7  f5                OSOPEN:	PUSH	AF		;SAVE CARRY
   173  00d8  cdbd02            	CALL	SETUP0
   174  00db  f1                	POP	AF
   175  00dc  d45302            	CALL	NC,CREATE
   176  00df  dc4902            	CALL	C,OPEN
   177  00e2  c8                	RET	Z		;ERROR
   178  00e3  0607              	LD	B,7		;MAX. NUMBER OF FILES
   179  00e5  211306            	LD	HL,TABLE+13
   180  00e8  7e                OPEN1:	LD	A,(HL)
   181  00e9  2b                	DEC	HL
   182  00ea  b6                	OR	(HL)
   183  00eb  281c              	JR	Z,OPEN2
   184  00ed  2b                	DEC	HL
   185  00ee  10f8              	DJNZ	OPEN1
   186  00f0  3ec0              	LD	A,192
   187  00f2  cd0000            	CALL	EXTERR
   188  00f5  546f6f206d616e79  	DEFM "Too many open files"
              206f70656e206669  
              6c6573            
   189  0108  00                	DEFB	0
   190                          ;
   191  0109  ed5b0000          OPEN2:	LD	DE,(FREE)	;FREE SPACE POINTER
   192  010d  73                	LD	(HL),E
   193  010e  23                	INC	HL
   194  010f  72                	LD	(HL),D
   195  0110  78                	LD	A,B		;CHANNEL (1-7)
   196  0111  21a600            	LD	HL,FCBSIZ
   197  0114  19                	ADD	HL,DE		;RESERVE SPACE
   198  0115  220000            	LD	(FREE),HL
   199  0118  215c00            	LD	HL,FCB
   200  011b  d5                	PUSH	DE
   201  011c  012400            	LD	BC,36
   202  011f  edb0              	LDIR			;COPY FCB
   203  0121  eb                	EX	DE,HL
   204  0122  23                	INC	HL
   205  0123  71                	LD	(HL),C		;CLEAR PTR
   206  0124  23                	INC	HL
   207  0125  d1                	POP	DE
   208  0126  47                	LD	B,A
   209  0127  cdd401            	CALL	RDF		;READ OR FILL
   210  012a  78                	LD	A,B
   211  012b  c30000            	JP	CHECK
   212                          ;
   213                          ;OSBPUT - Write a byte to a random disk file.
   214                          ;   Inputs: E = file channel
   215                          ;           A = byte to write
   216                          ; Destroys: A,B,C,F
   217                          ;
   218  012e  d5                OSBPUT:	PUSH	DE
   219  012f  e5                	PUSH	HL
   220  0130  47                	LD	B,A
   221  0131  cd8b02            	CALL	FIND
   222  0134  78                	LD	A,B
   223  0135  0600              	LD	B,0
   224  0137  2b                	DEC	HL
   225  0138  70                	LD	(HL),B		;CLEAR EOF
   226  0139  23                	INC	HL
   227  013a  4e                	LD	C,(HL)
   228  013b  cbb9              	RES	7,C
   229  013d  cbfe              	SET	7,(HL)
   230  013f  34                	INC	(HL)
   231  0140  23                	INC	HL
   232  0141  e5                	PUSH	HL
   233  0142  09                	ADD	HL,BC
   234  0143  77                	LD	(HL),A
   235  0144  e1                	POP	HL
   236  0145  ccd101            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   237  0148  e1                	POP	HL
   238  0149  d1                	POP	DE
   239  014a  c9                	RET
   240                          ;
   241                          ;OSBGET - Read a byte from a random disk file.
   242                          ;   Inputs: E = file channel
   243                          ;  Outputs: A = byte read
   244                          ;           Carry set if LAST BYTE of file
   245                          ; Destroys: A,B,C,F
   246                          ;
   247  014b  d5                OSBGET:	PUSH	DE
   248  014c  e5                	PUSH	HL
   249  014d  cd8b02            	CALL	FIND
   250  0150  4e                	LD	C,(HL)
   251  0151  cbb9              	RES	7,C
   252  0153  34                	INC	(HL)
   253  0154  23                	INC	HL
   254  0155  e5                	PUSH	HL
   255  0156  0600              	LD	B,0
   256  0158  09                	ADD	HL,BC
   257  0159  46                	LD	B,(HL)
   258  015a  e1                	POP	HL
   259  015b  ecec01            	CALL	PE,INCRDF	;INC SECTOR THEN READ
   260  015e  ccd101            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   261  0161  78                	LD	A,B
   262  0162  e1                	POP	HL
   263  0163  d1                	POP	DE
   264  0164  c9                	RET
   265                          ;
   266                          ;OSSTAT - Read file status.
   267                          ;   Inputs: E = file channel
   268                          ;  Outputs: Z flag set - EOF
   269                          ;           (If Z then A=0)
   270                          ;           DE = address of file block.
   271                          ; Destroys: A,D,E,H,L,F
   272                          ;
   273  0165  cd8b02            OSSTAT:	CALL	FIND
   274  0168  2b                	DEC	HL
   275  0169  7e                	LD	A,(HL)
   276  016a  3c                	INC	A
   277  016b  c9                	RET
   278                          ;
   279                          ;GETEXT - Find file size.
   280                          ;   Inputs: E = file channel
   281                          ;  Outputs: DEHL = file size (0-&800000)
   282                          ; Destroys: A,B,C,D,E,H,L,F
   283                          ;
   284  016c  cd8b02            GETEXT:	CALL	FIND
   285  016f  eb                	EX	DE,HL
   286  0170  115c00            	LD	DE,FCB
   287  0173  012400            	LD	BC,36
   288  0176  d5                	PUSH	DE
   289  0177  edb0              	LDIR			;COPY FCB
   290  0179  eb                	EX	DE,HL
   291  017a  e3                	EX	(SP),HL
   292  017b  eb                	EX	DE,HL
   293  017c  3e23              	LD	A,35
   294  017e  cdf901            	CALL	BDOS1		;COMPUTE SIZE
   295  0181  e1                	POP	HL
   296  0182  af                	XOR	A
   297  0183  1806              	JR	GETPT1
   298                          ;
   299                          ;GETPTR - Return file pointer.
   300                          ;   Inputs: E = file channel
   301                          ;  Outputs: DEHL = pointer (0-&7FFFFF)
   302                          ; Destroys: A,B,C,D,E,H,L,F
   303                          ;
   304  0185  cd8b02            GETPTR:	CALL	FIND
   305  0188  7e                	LD	A,(HL)
   306  0189  87                	ADD	A,A
   307  018a  2b                	DEC	HL
   308  018b  2b                GETPT1:	DEC	HL
   309  018c  56                	LD	D,(HL)
   310  018d  2b                	DEC	HL
   311  018e  5e                	LD	E,(HL)
   312  018f  2b                	DEC	HL
   313  0190  66                	LD	H,(HL)
   314  0191  6f                	LD	L,A
   315  0192  cb3a              	SRL	D
   316  0194  cb1b              	RR	E
   317  0196  cb1c              	RR	H
   318  0198  cb1d              	RR	L
   319  019a  c9                	RET
   320                          ;
   321                          ;PUTPTR - Update file pointer.
   322                          ;   Inputs: A = file channel
   323                          ;           DEHL = new pointer (0-&7FFFFF)
   324                          ; Destroys: A,B,C,D,E,H,L,F
   325                          ;
   326  019b  55                PUTPTR:	LD	D,L
   327  019c  29                	ADD	HL,HL
   328  019d  cb13              	RL	E
   329  019f  43                	LD	B,E
   330  01a0  4c                	LD	C,H
   331  01a1  5f                	LD	E,A		;CHANNEL
   332  01a2  d5                	PUSH	DE
   333  01a3  cd8b02            	CALL	FIND
   334  01a6  f1                	POP	AF
   335  01a7  e67f              	AND	7FH
   336  01a9  cb7e              	BIT	7,(HL)		;PENDING WRITE?
   337  01ab  2802              	JR	Z,PUTPT1
   338  01ad  f680              	OR	80H
   339  01af  77                PUTPT1:	LD	(HL),A
   340  01b0  d5                	PUSH	DE
   341  01b1  e5                	PUSH	HL
   342  01b2  2b                	DEC	HL
   343  01b3  2b                	DEC	HL
   344  01b4  2b                	DEC	HL
   345  01b5  56                	LD	D,(HL)
   346  01b6  2b                	DEC	HL
   347  01b7  5e                	LD	E,(HL)
   348  01b8  eb                	EX	DE,HL
   349  01b9  b7                	OR	A
   350  01ba  ed42              	SBC	HL,BC
   351  01bc  e1                	POP	HL
   352  01bd  d1                	POP	DE
   353  01be  c8                	RET	Z
   354  01bf  23                	INC	HL
   355  01c0  b7                	OR	A
   356  01c1  fc2502            	CALL	M,WRITE
   357  01c4  e5                	PUSH	HL
   358  01c5  2b                	DEC	HL
   359  01c6  2b                	DEC	HL
   360  01c7  2b                	DEC	HL
   361  01c8  3600              	LD	(HL),0
   362  01ca  2b                	DEC	HL
   363  01cb  70                	LD	(HL),B
   364  01cc  2b                	DEC	HL
   365  01cd  71                	LD	(HL),C		;NEW RECORD NO.
   366  01ce  e1                	POP	HL
   367  01cf  1803              	JR	RDF
   368                          ;
   369                          ;WRRDF - Write, read; if EOF fill with zeroes.
   370                          ;RDF - Read; if EOF fill with zeroes.
   371                          ;   Inputs: DE address FCB.
   372                          ;           HL addresses data buffer.
   373                          ;  Outputs: A=0, Z-flag set.
   374                          ;           Carry set if fill done (EOF)
   375                          ; Destroys: A,H,L,F
   376                          ;
   377  01d1  cd2502            WRRDF:	CALL	WRITE
   378  01d4  cdf401            RDF:	CALL	READ
   379  01d7  2b                	DEC	HL
   380  01d8  cbbe              	RES	7,(HL)
   381  01da  2b                	DEC	HL
   382  01db  77                	LD	(HL),A		;CLEAR EOF FLAG
   383  01dc  c8                	RET	Z
   384  01dd  36ff              	LD	(HL),-1		;SET EOF FLAG
   385  01df  23                	INC	HL
   386  01e0  23                	INC	HL
   387  01e1  c5                	PUSH	BC
   388  01e2  af                	XOR	A
   389  01e3  0680              	LD	B,128
   390  01e5  77                FILL:	LD	(HL),A
   391  01e6  23                	INC	HL
   392  01e7  10fc              	DJNZ	FILL
   393  01e9  c1                	POP	BC
   394  01ea  37                	SCF
   395  01eb  c9                	RET
   396                          ;
   397                          ;INCRDF - Increment record, read; if EOF fill.
   398                          ;   Inputs: DE addresses FCB.
   399                          ;           HL addresses data buffer.
   400                          ;  Outputs: A=1, Z-flag reset.
   401                          ;           Carry set if fill done (EOF)
   402                          ; Destroys: A,H,L,F
   403                          ;
   404  01ec  cd3e02            INCRDF:	CALL	INCSEC
   405  01ef  cdd401            	CALL	RDF
   406  01f2  3c                	INC	A
   407  01f3  c9                	RET
   408                          ;
   409                          ;READ - Read a record from a disk file.
   410                          ;   Inputs: DE addresses FCB.
   411                          ;           HL = address to store data.
   412                          ;  Outputs: A<>0 & Z-flag reset indicates EOF.
   413                          ;           Carry = 0
   414                          ; Destroys: A,F
   415                          ;
   416                          ;BDOS1 - CP/M BDOS call.
   417                          ;   Inputs: A = function number
   418                          ;          DE = parameter
   419                          ;  Outputs: AF = result (carry=0)
   420                          ; Destroys: A,F
   421                          ;
   422  01f4  cd8302            READ:	CALL	SETDMA
   423  01f7  3e21              	LD	A,33
   424  01f9  cd1002            BDOS1:	CALL	BDOS0
   425  01fc  2002              	JR	NZ,CPMERR
   426  01fe  b7                	OR	A
   427  01ff  c9                	RET
   428  0200  3eff              CPMERR:	LD	A,255
   429  0202  cd0000            	CALL	EXTERR
   430  0205  43502f4d20457272  	DEFM "CP/M Error"
              6f72              
   431  020f  00                	DEFB	0
   432                          ;
   433  0210  c5                BDOS0:	PUSH	BC
   434  0211  d5                	PUSH	DE
   435  0212  e5                	PUSH	HL
   436  0213  dde5              	PUSH	IX
   437  0215  fde5              	PUSH	IY
   438  0217  4f                	LD	C,A
   439  0218  cd0500            	CALL	BDOS
   440  021b  24                	INC	H
   441  021c  25                	DEC	H
   442  021d  fde1              	POP	IY
   443  021f  dde1              	POP	IX
   444  0221  e1                	POP	HL
   445  0222  d1                	POP	DE
   446  0223  c1                	POP	BC
   447  0224  c9                	RET
   448                          ;
   449                          ;WRITE - Write a record to a disk file.
   450                          ;   Inputs: DE addresses FCB.
   451                          ;           HL = address to get data.
   452                          ; Destroys: A,F
   453                          ;
   454  0225  cd8302            WRITE:	CALL	SETDMA
   455  0228  3e28              	LD	A,40
   456  022a  cdf901            	CALL	BDOS1
   457  022d  280f              	JR	Z,INCSEC
   458  022f  3ec6              	LD	A,198
   459  0231  cd0000            	CALL	EXTERR
   460  0234  4469736b2066756c  	DEFM "Disk full"
              6c                
   461  023d  00                	DEFB	0
   462                          ;
   463                          ;INCSEC - Increment random record number.
   464                          ;   Inputs: DE addresses FCB.
   465                          ; Destroys: F
   466                          ;
   467  023e  e5                INCSEC:	PUSH	HL
   468  023f  212100            	LD	HL,33
   469  0242  19                	ADD	HL,DE
   470  0243  34                INCS1:	INC	(HL)
   471  0244  23                	INC	HL
   472  0245  28fc              	JR	Z,INCS1
   473  0247  e1                	POP	HL
   474  0248  c9                	RET
   475                          ;
   476                          ;OPEN - Open a file for access.
   477                          ;   Inputs: FCB set up.
   478                          ;  Outputs: DE = FCB
   479                          ;           A=0 & Z-flag set indicates Not Found.
   480                          ;           Carry = 0
   481                          ; Destroys: A,D,E,F
   482                          ;
   483  0249  115c00            OPEN:	LD	DE,FCB
   484  024c  3e0f              	LD	A,15
   485  024e  cdf901            	CALL	BDOS1
   486  0251  3c                	INC	A
   487  0252  c9                	RET
   488                          ;
   489                          ;CREATE - Create a disk file for writing.
   490                          ;   Inputs: FCB set up.
   491                          ;  Outputs: DE = FCB
   492                          ;           A=0 & Z-flag set indicates directory full.
   493                          ;           Carry = 0
   494                          ; Destroys: A,D,E,F
   495                          ;
   496  0253  cd6502            CREATE:	CALL	CHKAMB
   497  0256  115c00            	LD	DE,FCB
   498  0259  3e13              	LD	A,19
   499  025b  cdf901            	CALL	BDOS1		;DELETE
   500  025e  3e16              	LD	A,22
   501  0260  cdf901            	CALL	BDOS1		;MAKE
   502  0263  3c                	INC	A
   503  0264  c9                	RET
   504                          ;
   505                          ;CHKAMB - Check for ambiguous filename.
   506                          ; Destroys: A,D,E,F
   507                          ;
   508  0265  c5                CHKAMB:	PUSH	BC
   509  0266  115c00            	LD	DE,FCB
   510  0269  060c              	LD	B,12
   511  026b  1a                CHKAM1:	LD	A,(DE)
   512  026c  fe3f              	CP	'?'
   513  026e  2805              	JR	Z,AMBIG		;AMBIGUOUS
   514  0270  13                	INC	DE
   515  0271  10f8              	DJNZ	CHKAM1
   516  0273  c1                	POP	BC
   517  0274  c9                	RET
   518  0275  3ecc              AMBIG:	LD	A,204
   519  0277  cd0000            	CALL	EXTERR
   520  027a  426164206e616d65  	DEFM "Bad name"
   521  0282  00                	DEFB	0
   522                          ;
   523                          ;SETDMA - Set "DMA" address.
   524                          ;   Inputs: HL = address
   525                          ; Destroys: A,F
   526                          ;
   527  0283  3e1a              SETDMA:	LD	A,26
   528  0285  eb                	EX	DE,HL
   529  0286  cd1002            	CALL	BDOS0
   530  0289  eb                	EX	DE,HL
   531  028a  c9                	RET
   532                          ;
   533                          ;FIND - Find file parameters from channel.
   534                          ;   Inputs: E = channel
   535                          ;  Outputs: DE addresses FCB
   536                          ;           HL addresses pointer byte (FCB+37)
   537                          ; Destroys: A,D,E,H,L,F
   538                          ;
   539  028b  1c                FIND:	INC	E
   540  028c  1d                	DEC	E
   541  028d  2808              	JR	Z,CHANER
   542  028f  cdac02            	CALL	FIND1
   543  0292  212500            	LD	HL,37
   544  0295  19                	ADD	HL,DE
   545  0296  c0                	RET	NZ
   546  0297  3ede              CHANER:	LD	A,222
   547  0299  cd0000            	CALL	EXTERR
   548  029c  496e76616c696420  	DEFM "Invalid channel"
              6368616e6e656c    
   549  02ab  00                	DEFB	0
   550                          ;
   551                          ;FIND1 - Look up file table.
   552                          ;   Inputs: E = channel
   553                          ;  Outputs: Z-flag set = file not opened
   554                          ;           If NZ, DE addresses FCB
   555                          ;                  HL points into table
   556                          ; Destroys: A,D,E,H,L,F
   557                          ;
   558  02ac  7b                FIND1:	LD	A,E
   559  02ad  e607              	AND	7
   560  02af  87                	ADD	A,A
   561  02b0  5f                	LD	E,A
   562  02b1  1600              	LD	D,0
   563  02b3  210406            	LD	HL,TABLE-2
   564  02b6  19                	ADD	HL,DE
   565  02b7  5e                	LD	E,(HL)
   566  02b8  23                	INC	HL
   567  02b9  56                	LD	D,(HL)
   568  02ba  7a                	LD	A,D
   569  02bb  b3                	OR	E
   570  02bc  c9                	RET
   571                          ;
   572                          ;SETUP - Set up File Control Block.
   573                          ;   Inputs: HL addresses filename
   574                          ;           Format  [A:]FILENAME[.EXT]
   575                          ;           Device defaults to current drive
   576                          ;           Extension defaults to .BBC
   577                          ;           A = fill character
   578                          ;  Outputs: HL updated
   579                          ;           A = terminator
   580                          ;           BC = 128
   581                          ; Destroys: A,B,C,H,L,F
   582                          ;
   583                          ;FCB FORMAT (36 BYTES TOTAL):
   584                          ; 0      0=SAME DISK, 1=DISK A, 2=DISK B (ETC.)
   585                          ; 1-8    FILENAME, PADDED WITH SPACES
   586                          ; 9-11   EXTENSION, PADDED WITH SPACES
   587                          ; 12     CURRENT EXTENT, SET TO ZERO
   588                          ; 32-35  CLEARED TO ZERO
   589                          ;
   590  02bd  3e20              SETUP0:	LD	A,' '
   591  02bf  d5                SETUP:	PUSH	DE
   592  02c0  e5                	PUSH	HL
   593  02c1  116500            	LD	DE,FCB+9
   594  02c4  216803            	LD	HL,BBC
   595  02c7  010300            	LD	BC,3
   596  02ca  edb0              	LDIR
   597  02cc  217c00            	LD	HL,FCB+32
   598  02cf  0604              	LD	B,4
   599  02d1  71                SETUP1:	LD	(HL),C
   600  02d2  23                	INC	HL
   601  02d3  10fc              	DJNZ	SETUP1
   602  02d5  e1                	POP	HL
   603  02d6  4f                	LD	C,A
   604  02d7  af                	XOR	A
   605  02d8  12                	LD	(DE),A
   606  02d9  d1                	POP	DE
   607  02da  cd6103            	CALL	SKIPSP
   608  02dd  fe22              	CP	'"'
   609  02df  2027              	JR	NZ,SETUP2
   610  02e1  23                	INC	HL
   611  02e2  cd6103            	CALL	SKIPSP
   612  02e5  cd0803            	CALL	SETUP2
   613  02e8  fe22              	CP	'"'
   614  02ea  23                	INC	HL
   615  02eb  2874              	JR	Z,SKIPSP
   616  02ed  3efd              BADSTR:	LD	A,253
   617  02ef  cd0000            	CALL	EXTERR
   618  02f2  4261642073747269  	DEFM "Bad string"
              6e67              
   619  02fc  00                	DEFB	0
   620                          ;
   621  02fd  7e                PARSE:	LD	A,(HL)
   622  02fe  23                	INC	HL
   623  02ff  fe60              	CP	'`'
   624  0301  d0                	RET	NC
   625  0302  fe3f              	CP	'?'
   626  0304  d8                	RET	C
   627  0305  ee40              	XOR	40H
   628  0307  c9                	RET
   629                          ;
   630  0308  d5                SETUP2:	PUSH	DE
   631  0309  23                	INC	HL
   632  030a  7e                	LD	A,(HL)
   633  030b  fe3a              	CP	':'
   634  030d  2b                	DEC	HL
   635  030e  78                	LD	A,B
   636  030f  2005              	JR	NZ,DEVICE
   637  0311  7e                	LD	A,(HL)		;DRIVE
   638  0312  e61f              	AND	31
   639  0314  23                	INC	HL
   640  0315  23                	INC	HL
   641  0316  115c00            DEVICE:	LD	DE,FCB
   642  0319  12                	LD	(DE),A
   643  031a  13                	INC	DE
   644  031b  0608              	LD	B,8
   645  031d  7e                COPYF:	LD	A,(HL)
   646  031e  fe2e              	CP	'.'
   647  0320  2822              	JR	Z,COPYF1
   648  0322  fe20              	CP	' '
   649  0324  281e              	JR	Z,COPYF1
   650  0326  fe0d              	CP	CR
   651  0328  281a              	JR	Z,COPYF1
   652  032a  fe3d              	CP	'='
   653  032c  2816              	JR	Z,COPYF1
   654  032e  fe22              	CP	'"'
   655  0330  2812              	JR	Z,COPYF1
   656  0332  0e3f              	LD	C,'?'
   657  0334  fe2a              	CP	'*'
   658  0336  280c              	JR	Z,COPYF1
   659  0338  0e20              	LD	C,' '
   660  033a  23                	INC	HL
   661  033b  fe7c              	CP	'|'
   662  033d  2006              	JR	NZ,COPYF2
   663  033f  cdfd02            	CALL	PARSE
   664  0342  1804              	JR	COPYF0
   665  0344  79                COPYF1:	LD	A,C
   666  0345  cde804            COPYF2:	CALL	UPPRC
   667  0348  12                COPYF0:	LD	(DE),A
   668  0349  13                	INC	DE
   669  034a  10d1              	DJNZ	COPYF
   670  034c  7e                COPYF3:	LD	A,(HL)
   671  034d  23                	INC	HL
   672  034e  fe2a              	CP	'*'
   673  0350  28fa              	JR	Z,COPYF3
   674  0352  fe2e              	CP	'.'
   675  0354  012003            	LD	BC,3*256+' '
   676  0357  116500            	LD	DE,FCB+9
   677  035a  28c1              	JR	Z,COPYF
   678  035c  2b                	DEC	HL
   679  035d  d1                	POP	DE
   680  035e  018000            	LD	BC,128
   681  0361  7e                SKIPSP:	LD	A,(HL)
   682  0362  fe20              	CP	' '
   683  0364  c0                	RET	NZ
   684  0365  23                	INC	HL
   685  0366  18f9              	JR	SKIPSP
   686                          ;
   687  0368  424243            BBC:	DEFM "BBC"
   688                          ;
   689                          ;HEX - Read a hex string and convert to binary.
   690                          ;   Inputs: HL = text pointer
   691                          ;  Outputs: HL = updated text pointer
   692                          ;           DE = value
   693                          ;            A = terminator (spaces skipped)
   694                          ; Destroys: A,D,E,H,L,F
   695                          ;
   696  036b  110000            HEX:	LD	DE,0		;INITIALISE
   697  036e  cd6103            	CALL	SKIPSP
   698  0371  7e                HEX1:	LD	A,(HL)
   699  0372  cde804            	CALL	UPPRC
   700  0375  fe30              	CP	'0'
   701  0377  38e8              	JR	C,SKIPSP
   702  0379  fe3a              	CP	'9'+1
   703  037b  380a              	JR	C,HEX2
   704  037d  fe41              	CP	'A'
   705  037f  38e0              	JR	C,SKIPSP
   706  0381  fe47              	CP	'F'+1
   707  0383  30dc              	JR	NC,SKIPSP
   708  0385  d607              	SUB	7
   709  0387  e60f              HEX2:	AND	0FH
   710  0389  eb                	EX	DE,HL
   711  038a  29                	ADD	HL,HL
   712  038b  29                	ADD	HL,HL
   713  038c  29                	ADD	HL,HL
   714  038d  29                	ADD	HL,HL
   715  038e  eb                	EX	DE,HL
   716  038f  b3                	OR	E
   717  0390  5f                	LD	E,A
   718  0391  23                	INC	HL
   719  0392  18dd              	JR	HEX1
   720                          ;
   721                          ;OSCLI - Process an "operating system" command
   722                          ;
   723  0394  cd6103            OSCLI:	CALL	SKIPSP
   724  0397  fe0d              	CP	CR
   725  0399  c8                	RET	Z
   726  039a  fe7c              	CP	'|'
   727  039c  c8                	RET	Z
   728  039d  fe2e              	CP	'.'
   729  039f  ca7904            	JP	Z,DOT		;*.
   730  03a2  eb                	EX	DE,HL
   731  03a3  21f804            	LD	HL,COMDS
   732  03a6  1a                OSCLI0:	LD	A,(DE)
   733  03a7  cde804            	CALL	UPPRC
   734  03aa  be                	CP	(HL)
   735  03ab  280b              	JR	Z,OSCLI2
   736  03ad  382e              	JR	C,UNK
   737  03af  cb7e              OSCLI1:	BIT	7,(HL)
   738  03b1  23                	INC	HL
   739  03b2  28fb              	JR	Z,OSCLI1
   740  03b4  23                	INC	HL
   741  03b5  23                	INC	HL
   742  03b6  18ee              	JR	OSCLI0
   743                          ;
   744  03b8  d5                OSCLI2:	PUSH	DE
   745  03b9  13                OSCLI3:	INC	DE
   746  03ba  23                	INC	HL
   747  03bb  1a                	LD	A,(DE)
   748  03bc  cde804            	CALL	UPPRC
   749  03bf  fe2e              	CP	'.'		;ABBREVIATED?
   750  03c1  280a              	JR	Z,OSCLI4
   751  03c3  ae                	XOR	(HL)
   752  03c4  28f3              	JR	Z,OSCLI3
   753  03c6  fe80              	CP	80H
   754  03c8  2803              	JR	Z,OSCLI4
   755  03ca  d1                	POP	DE
   756  03cb  18e2              	JR	OSCLI1
   757                          ;
   758  03cd  f1                OSCLI4:	POP	AF
   759  03ce  13                	INC	DE
   760  03cf  cb7e              OSCLI5:	BIT	7,(HL)
   761  03d1  23                	INC	HL
   762  03d2  28fb              	JR	Z,OSCLI5
   763  03d4  7e                	LD	A,(HL)
   764  03d5  23                	INC	HL
   765  03d6  66                	LD	H,(HL)
   766  03d7  6f                	LD	L,A
   767  03d8  e5                	PUSH	HL
   768  03d9  eb                	EX	DE,HL
   769  03da  c36103            	JP	SKIPSP
   770                          ;
   771  03dd  eb                UNK:	EX	DE,HL
   772  03de  c3f7ff            	JP	ASCLI
   773                          ;
   774                          ;
   775  03e1  c7                BYE:	RST	0		;*BYE, *QUIT
   776                          ;
   777  03e2  cdbd02            ERA:	CALL	SETUP0		;*ERA, *ERASE
   778  03e5  0e13              	LD	C,19
   779  03e7  1833              	JR	XEQ		;"DELETE"
   780                          ;
   781  03e9  0e0d              RES:	LD	C,13		;*RESET
   782  03eb  182f              	JR	XEQ		;"RESET"
   783                          ;
   784  03ed  cdbd02            DRV:	CALL	SETUP0		;*DRIVE
   785  03f0  3a5c00            	LD	A,(FCB)
   786  03f3  3d                	DEC	A
   787  03f4  fa2904            	JP	M,HUH
   788  03f7  5f                	LD	E,A
   789  03f8  0e0e              	LD	C,14
   790  03fa  1823              	JR	XEQ0
   791                          ;
   792  03fc  cdbd02            REN:	CALL	SETUP0		;*REN, *RENAME
   793  03ff  fe3d              	CP	'='
   794  0401  2026              	JR	NZ,HUH
   795  0403  23                	INC	HL
   796  0404  e5                	PUSH	HL
   797  0405  cd3a04            	CALL	EXISTS
   798  0408  215c00            	LD	HL,FCB
   799  040b  116c00            	LD	DE,FCB+16
   800  040e  010c00            	LD	BC,12
   801  0411  edb0              	LDIR
   802  0413  e1                	POP	HL
   803  0414  cdbd02            	CALL	SETUP0
   804  0417  cd6502            	CALL	CHKAMB
   805  041a  0e17              	LD	C,23
   806  041c  115c00            XEQ:	LD	DE,FCB
   807  041f  7e                XEQ0:	LD	A,(HL)
   808  0420  fe0d              	CP	CR
   809  0422  2005              	JR	NZ,HUH
   810  0424  79                BDC:	LD	A,C
   811  0425  cdf901            	CALL	BDOS1
   812  0428  f0                	RET	P
   813  0429  3efe              HUH:	LD	A,254
   814  042b  cd0000            	CALL	EXTERR
   815  042e  42616420636f6d6d  	DEFM "Bad command"
              616e64            
   816  0439  00                	DEFB	0
   817                          ;
   818  043a  218000            EXISTS:	LD	HL,DSKBUF
   819  043d  cd8302            	CALL	SETDMA
   820  0440  115c00            	LD	DE,FCB
   821  0443  3e11              	LD	A,17
   822  0445  cdf901            	CALL	BDOS1		;SEARCH
   823  0448  3c                	INC	A
   824  0449  c8                	RET	Z
   825  044a  3ec4              	LD	A,196
   826  044c  cd0000            	CALL	EXTERR
   827  044f  46696c6520657869  	DEFM "File exists"
              737473            
   828  045a  00                	DEFB	0
   829                          ;
   830  045b  cdbd02            SAVLOD:	CALL	SETUP0		;PART OF *SAVE, *LOAD
   831  045e  cd6b03            	CALL	HEX
   832  0461  fe2b              	CP	'+'
   833  0463  f5                	PUSH	AF
   834  0464  d5                	PUSH	DE
   835  0465  2001              	JR	NZ,SAVLO1
   836  0467  23                	INC	HL
   837  0468  cd6b03            SAVLO1:	CALL	HEX
   838  046b  fe0d              	CP	CR
   839  046d  20ba              	JR	NZ,HUH
   840  046f  eb                	EX	DE,HL
   841  0470  d1                	POP	DE
   842  0471  f1                	POP	AF
   843  0472  c8                	RET	Z
   844  0473  b7                	OR	A
   845  0474  ed52              	SBC	HL,DE
   846  0476  c0                	RET	NZ
   847  0477  18b0              	JR	HUH
   848                          ;
   849  0479  23                DOT:	INC	HL
   850  047a  3e3f              DIR:	LD	A,'?'		;*DIR
   851  047c  cdbf02            	CALL	SETUP
   852  047f  fe0d              	CP	CR
   853  0481  20a6              	JR	NZ,HUH
   854  0483  0e11              	LD	C,17
   855  0485  0604              DIR0:	LD	B,4
   856  0487  cd5805            DIR1:	CALL	LTRAP
   857  048a  115c00            	LD	DE,FCB
   858  048d  218000            	LD	HL,DSKBUF
   859  0490  cd8302            	CALL	SETDMA
   860  0493  79                	LD	A,C
   861  0494  cdf901            	CALL	BDOS1		;SEARCH DIRECTORY
   862  0497  fa0000            	JP	M,CRLF
   863  049a  0f                	RRCA
   864  049b  0f                	RRCA
   865  049c  0f                	RRCA
   866  049d  e660              	AND	60H
   867  049f  5f                	LD	E,A
   868  04a0  1600              	LD	D,0
   869  04a2  218100            	LD	HL,DSKBUF+1
   870  04a5  19                	ADD	HL,DE
   871  04a6  e5                	PUSH	HL
   872  04a7  110800            	LD	DE,8
   873  04aa  19                	ADD	HL,DE
   874  04ab  5e                	LD	E,(HL)
   875  04ac  23                	INC	HL
   876  04ad  cb7e              	BIT	7,(HL)		;SYSTEM FILE?
   877  04af  e1                	POP	HL
   878  04b0  0e12              	LD	C,18
   879  04b2  20d3              	JR	NZ,DIR1
   880  04b4  c5                	PUSH	BC
   881  04b5  78                	LD	A,B
   882  04b6  fe04              	CP	4
   883  04b8  3e20              	LD	A,' '
   884  04ba  ccdc04            	CALL	Z,DRIVE
   885  04bd  cdd005            	CALL	OSWRCH
   886  04c0  0608              	LD	B,8
   887  04c2  3e20              	LD	A,' '
   888  04c4  cb7b              	BIT	7,E		;READ ONLY?
   889  04c6  2802              	JR	Z,DIR3
   890  04c8  3e2a              	LD	A,'*'
   891  04ca  cd6505            DIR3:	CALL	CPTEXT
   892  04cd  0603              	LD	B,3
   893  04cf  3e20              	LD	A,' '
   894  04d1  cd6c05            	CALL	SPTEXT
   895  04d4  c1                	POP	BC
   896  04d5  10b0              	DJNZ	DIR1
   897  04d7  cd0000            	CALL	CRLF
   898  04da  18a9              	JR	DIR0
   899                          ;
   900  04dc  3a5c00            DRIVE:	LD	A,(FCB)
   901  04df  3d                	DEC	A
   902  04e0  0e19              	LD	C,25
   903  04e2  fc2404            	CALL	M,BDC
   904  04e5  c641              	ADD	A,'A'
   905  04e7  c9                	RET
   906                          ;
   907  04e8  e67f              UPPRC:	AND	7FH
   908  04ea  fe60              	CP	'`'
   909  04ec  d8                	RET	C
   910  04ed  e65f              	AND	5FH		;CONVERT TO UPPER CASE
   911  04ef  c9                	RET
   912                          ;
   913  04f0  0620              HELP:	LD	B,32		;*HELP
   914  04f2  210000            	LD	HL,VERMSG
   915  04f5  c36f05            	JP	PTEXT
   916                          ;
   917                          ;
   918  04f8  4259              COMDS:	DEFM "BY"
   919  04fa  c5                	DEFB	'E'+80H
   920  04fb  e103              	DEFW	BYE
   921  04fd  4350              	DEFM "CP"
   922  04ff  cd                	DEFB	'M'+80H
   923  0500  e103              	DEFW	BYE
   924  0502  4449              	DEFM "DI"
   925  0504  d2                	DEFB	'R'+80H
   926  0505  7a04              	DEFW	DIR
   927  0507  44524956          	DEFM "DRIV"
   928  050b  c5                	DEFB	'E'+80H
   929  050c  ed03              	DEFW	DRV
   930  050e  45524153          	DEFM "ERAS"
   931  0512  c5                	DEFB	'E'+80H
   932  0513  e203              	DEFW	ERA
   933  0515  4552              	DEFM "ER"
   934  0517  c1                	DEFB	'A'+80H
   935  0518  e203              	DEFW	ERA
   936  051a  48454c            	DEFM "HEL"
   937  051d  d0                	DEFB	'P'+80H
   938  051e  f004              	DEFW	HELP
   939  0520  4c4f41            	DEFM "LOA"
   940  0523  c4                	DEFB	'D'+80H
   941  0524  9c00              	DEFW	STLOAD
   942  0526  515549            	DEFM "QUI"
   943  0529  d4                	DEFB	'T'+80H
   944  052a  e103              	DEFW	BYE
   945  052c  52454e414d        	DEFM "RENAM"
   946  0531  c5                	DEFB	'E'+80H
   947  0532  fc03              	DEFW	REN
   948  0534  5245              	DEFM "RE"
   949  0536  ce                	DEFB	'N'+80H
   950  0537  fc03              	DEFW	REN
   951  0539  52455345          	DEFM "RESE"
   952  053d  d4                	DEFB	'T'+80H
   953  053e  e903              	DEFW	RES
   954  0540  534156            	DEFM "SAV"
   955  0543  c5                	DEFB	'E'+80H
   956  0544  0000              	DEFW	STSAVE
   957  0546  545950            	DEFM "TYP"
   958  0549  c5                	DEFB	'E'+80H
   959  054a  8700              	DEFW	TYPE
   960  054c  ff                	DEFB	0FFH
   961                          ;
   962                          ;PROCESS 6502's BRK INSTRUCTION
   963                          ;
   964  054d  2a82ff            BRK:	LD	HL,(BRKPTR)
   965  0550  e5                	PUSH	HL
   966  0551  e1                BRKTRP:	POP	HL
   967  0552  7e                	LD	A,(HL)
   968  0553  23                	INC	HL
   969  0554  e5                	PUSH	HL
   970  0555  c30000            	JP	EXTERR
   971                          ;
   972                          ;TRAP - Test for "ESC" and abort if so.
   973                          ;  Destroys: A,H,L,F
   974                          ;
   975                          TRAP:
   976  0558  3a80ff            LTRAP:	LD	A,(BRKFLG)
   977  055b  b7                	OR	A
   978  055c  f0                	RET	P
   979  055d  3e7e              ESC:	LD	A,126
   980  055f  cdf4ff            	CALL	ASBYTE
   981  0562  c30000            	JP	ESCAPE
   982                          ;
   983                          ;PTEXT - Print text
   984                          ;   Inputs: HL = address of text
   985                          ;            B = number of characters to print
   986                          ; Destroys: A,B,H,L,F
   987                          ;
   988  0565  f5                CPTEXT:	PUSH	AF
   989  0566  3e3a              	LD	A,':'
   990  0568  cdd005            	CALL	OSWRCH
   991  056b  f1                	POP	AF
   992  056c  cdd005            SPTEXT:	CALL	OSWRCH
   993  056f  7e                PTEXT:	LD	A,(HL)
   994  0570  e67f              	AND	7FH
   995  0572  23                	INC	HL
   996  0573  cdd005            	CALL	OSWRCH
   997  0576  10f7              	DJNZ	PTEXT
   998  0578  c9                	RET
   999                          ;
  1000                          ;OSINIT - Initialise RAM mapping etc.
  1001                          ;If BASIC is entered by BBCBASIC FILENAME then file
  1002                          ;FILENAME.BBC is automatically CHAINed.
  1003                          ;   Outputs: DE = initial value of HIMEM (top of RAM)
  1004                          ;            HL = initial value of PAGE (user program)
  1005                          ;            Z-flag reset indicates AUTO-RUN.
  1006                          ;  Destroys: A,B,C,D,E,H,L,F
  1007                          ;
  1008  0579  3ec3              OSINIT:	LD	A,0C3H
  1009  057b  323800            	LD	(38H),A
  1010  057e  215105            	LD	HL,BRKTRP
  1011  0581  223900            	LD	(39H),HL
  1012  0584  214d05            	LD	HL,BRK
  1013  0587  22faff            	LD	(BRKVEC),HL
  1014  058a  3ee5              	LD	A,229
  1015  058c  210000            	LD	HL,0
  1016  058f  cdf4ff            	CALL	ASBYTE		;ESC interrupts program
  1017  0592  3ee6              	LD	A,230
  1018  0594  210000            	LD	HL,0
  1019  0597  cdf4ff            	CALL	ASBYTE		;ESC flushes buffers
  1020  059a  0e2d              	LD	C,45
  1021  059c  1efe              	LD	E,254
  1022  059e  cd0500            	CALL	BDOS		;TRAP ERRORS (CP/M 3)
  1023  05a1  af                	XOR	A
  1024  05a2  060e              	LD	B,INILEN
  1025  05a4  210606            	LD	HL,TABLE
  1026  05a7  77                CLRTAB:	LD	(HL),A		;CLEAR FILE TABLE
  1027  05a8  23                	INC	HL
  1028  05a9  10fc              	DJNZ	CLRTAB
  1029  05ab  110000            	LD	DE,ACCS
  1030  05ae  218000            	LD	HL,DSKBUF
  1031  05b1  4e                	LD	C,(HL)
  1032  05b2  23                	INC	HL
  1033  05b3  b9                	CP	C
  1034  05b4  2802              	JR	Z,NOBOOT
  1035  05b6  edb0              	LDIR			;COPY TO ACCS
  1036  05b8  eb                NOBOOT:	EX	DE,HL
  1037  05b9  360d              	LD	(HL),CR
  1038  05bb  ed5b0600          	LD	DE,(6)		;DE = HIMEM
  1039  05bf  5f                	LD	E,A		;PAGE BOUNDARY
  1040  05c0  210000            	LD	HL,USER
  1041  05c3  c9                	RET
  1042                          ;
  1043                          ;OSRDCH - Read a character from console input.
  1044                          ;  Outputs: A = character.
  1045                          ; Destroys: A,F
  1046                          ;
  1047  05c4  c5                OSRDCH:	PUSH	BC
  1048  05c5  d5                	PUSH	DE
  1049  05c6  e5                	PUSH	HL
  1050  05c7  cde0ff            	CALL	ASRDCH
  1051  05ca  e1                	POP	HL
  1052  05cb  d1                	POP	DE
  1053  05cc  c1                	POP	BC
  1054  05cd  c9                	RET
  1055                          ;
  1056                          ;OSWRCH - Write a character to console output.
  1057                          ;   Inputs: A = character.
  1058                          ; Destroys: Nothing
  1059                          ;
  1060  05ce  3e3e              PROMPT:	LD	A,'>'
  1061  05d0  f5                OSWRCH:	PUSH	AF
  1062  05d1  c5                	PUSH	BC
  1063  05d2  d5                	PUSH	DE
  1064  05d3  e5                	PUSH	HL
  1065  05d4  cdeeff            	CALL	ASWRCH
  1066  05d7  e1                	POP	HL
  1067  05d8  d1                	POP	DE
  1068  05d9  c1                	POP	BC
  1069  05da  f1                	POP	AF
  1070  05db  c9                	RET
  1071                          ;
  1072                          ;OSLINE - Read a complete line, terminated by
  1073                          ;carriage-return.
  1074                          ;   Inputs: HL addresses destination buffer.
  1075                          ;           (L=0)
  1076                          ;  Outputs: Buffer filled, terminated by CR.
  1077                          ;           A=0.
  1078                          ;  Destroys: A,B,C,D,E,H,L,IX,F
  1079                          ;
  1080  05dc  dd211406          OSLINE:	LD	IX,SCRAP
  1081  05e0  dd7500            	LD	(IX+0),L
  1082  05e3  dd7401            	LD	(IX+1),H
  1083  05e6  dd3602ff          	LD	(IX+2),255	;MAX. LINE LENGTH
  1084  05ea  dd360320          	LD	(IX+3),' '	;MIN. ASCII VALUE
  1085  05ee  dd3604ff          	LD	(IX+4),255	;MAX. ASCII VALUE
  1086  05f2  3eda              	LD	A,218
  1087  05f4  210000            	LD	HL,0
  1088  05f7  cdf4ff            	CALL	ASBYTE		;FLUSH VDU QUEUE
  1089  05fa  af                	XOR	A
  1090  05fb  211406            	LD	HL,SCRAP
  1091  05fe  cdf1ff            	CALL	ASWORD
  1092  0601  da5d05            	JP	C,ESC
  1093  0604  af                	XOR	A
  1094  0605  c9                	RET
  1095                          ;
  1096                          CR	EQU	0DH
  1097                          FCBSIZ	EQU	128+36+2
  1098                          ;
  1099                          BDOS	EQU	5
  1100                          ;
  1101                          BRKFLG	EQU	0FF80H
  1102                          BRKPTR	EQU	0FF82H
  1103                          ASRDCH	EQU	0FFE0H
  1104                          ASWRCH	EQU	0FFEEH
  1105                          ASWORD	EQU	0FFF1H
  1106                          ASBYTE	EQU	0FFF4H
  1107                          ASCLI	EQU	0FFF7H
  1108                          BRKVEC	EQU	0FFFAH
  1109                          ;
  1110                          FCB	EQU	5CH
  1111                          DSKBUF	EQU	80H
  1112                          ;
  1113  0606  0000000000000000  TABLE:	DEFS	14		;FILE BLOCK POINTERS
              000000000000      
  1114                          INILEN	EQU	$-TABLE
  1115  0614  0000000000000000  SCRAP:	DEFS	31
              0000000000000000  
              0000000000000000  
              00000000000000    
  1116  0633  00                	DEFB	0
  1117                          ;
  1118                          FIN: ; END
  1119                          
  1120                          
